<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Мои Финансы</title>
    <!-- Подключаем Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключаем иконки Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Подключаем Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Плавность анимаций */
        .fade-in {
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Убираем стрелочки у input type number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        /* Учитываем "челку" и нижнюю полоску iPhone */
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        .safe-area-top {
            padding-top: env(safe-area-inset-top);
        }
        /* Стили для нижней навигации */
        .nav-item.active {
            color: #2563eb; /* blue-600 */
        }
        .nav-item.active svg {
            fill: rgba(37, 99, 235, 0.1);
        }
        /* Затемнение фона модалки */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans pb-28 min-h-screen selection:bg-blue-100">

    <!-- HEADER (Sticky) -->
    <header class="bg-white/90 backdrop-blur-md border-b border-slate-200 sticky top-0 z-40 shadow-sm safe-area-top transition-all duration-300">
        <div class="max-w-md mx-auto px-4 py-3">
            <!-- Top Row: App Title & Balance -->
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <div class="bg-blue-600 p-1.5 rounded-lg shadow-sm shadow-blue-200">
                        <i data-lucide="wallet" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-base font-bold text-slate-800 leading-tight">Мои Финансы</h1>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wide">Баланс</p>
                    <p id="header-balance" class="font-bold text-lg text-emerald-600 leading-none">0 ₸</p>
                </div>
            </div>

            <!-- Bottom Row: Month Navigation Control -->
            <div class="bg-slate-100 p-1 rounded-xl flex items-center justify-between">
                <button onclick="changeMonth(-1)" class="w-10 h-8 flex items-center justify-center bg-white rounded-lg text-slate-500 shadow-sm active:scale-95 transition-all border border-slate-200 hover:text-blue-600">
                    <i data-lucide="chevron-left" class="w-5 h-5"></i>
                </button>
                
                <div class="flex items-center gap-2">
                    <i data-lucide="calendar" class="w-4 h-4 text-slate-400"></i>
                    <span id="current-month-display" class="text-sm font-bold text-slate-700 capitalize">...</span>
                </div>

                <button onclick="changeMonth(1)" class="w-10 h-8 flex items-center justify-center bg-white rounded-lg text-slate-500 shadow-sm active:scale-95 transition-all border border-slate-200 hover:text-blue-600">
                    <i data-lucide="chevron-right" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto px-3 py-4 space-y-4">
        
        <!-- VIEW: SUMMARY -->
        <div id="view-summary" class="fade-in block">
            <!-- Main Balance Card -->
            <div class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-2xl p-5 text-white shadow-lg shadow-blue-200 mb-4">
                <p class="text-blue-100 text-sm font-medium mb-1">Доступно сейчас</p>
                <h2 id="hero-balance" class="text-3xl font-bold mb-4">0 ₸</h2>
                <div class="grid grid-cols-2 gap-4 border-t border-blue-500/30 pt-4">
                    <div>
                        <p class="text-blue-200 text-xs mb-1">Доходы</p>
                        <p id="hero-income" class="font-semibold text-lg">0 ₸</p>
                    </div>
                    <div>
                        <p class="text-blue-200 text-xs mb-1">Расходы</p>
                        <p id="hero-spent" class="font-semibold text-lg">0 ₸</p>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                 <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex items-center gap-2 mb-2 text-slate-500">
                        <i data-lucide="pie-chart" class="w-4 h-4"></i>
                        <span class="text-xs font-bold uppercase">План</span>
                    </div>
                    <p id="summary-budget" class="text-xl font-bold text-slate-800">0 ₸</p>
                 </div>
                 <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex items-center gap-2 mb-2 text-slate-500">
                        <i data-lucide="target" class="w-4 h-4"></i>
                        <span class="text-xs font-bold uppercase">Осталось</span>
                    </div>
                    <p id="summary-remaining" class="text-xl font-bold text-slate-800">0 ₸</p>
                 </div>
            </div>

            <!-- Budget Status Bar -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 mb-6">
                <h3 class="font-bold text-sm text-slate-700 mb-3">Исполнение бюджета</h3>
                <div class="relative pt-1">
                    <div class="flex mb-2 items-center justify-between">
                        <span id="budget-text" class="text-xs font-medium text-slate-500">Загрузка...</span>
                        <span id="budget-percent" class="text-xs font-bold bg-slate-100 px-2 py-1 rounded-full text-slate-600">0%</span>
                    </div>
                    <div class="overflow-hidden h-2.5 mb-1 text-xs flex rounded-full bg-slate-100">
                        <div id="budget-progress-bar" style="width: 0%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500 transition-all duration-500 rounded-full"></div>
                    </div>
                </div>
            </div>

            <!-- Reset Data Button -->
            <div class="text-center">
                <button onclick="resetData()" class="text-xs text-slate-400 underline hover:text-red-500 transition-colors">
                    Очистить данные за этот месяц
                </button>
            </div>
        </div>

        <!-- VIEW: INCOME -->
        <div id="view-income" class="fade-in hidden pb-20">
            <div class="bg-emerald-50 border border-emerald-100 rounded-xl p-3 mb-4 flex items-start gap-3">
                <i data-lucide="info" class="w-5 h-5 text-emerald-500 mt-0.5 shrink-0"></i>
                <p class="text-xs text-emerald-800 leading-relaxed">
                    Данные автоматически сохраняются для выбранного месяца.
                </p>
            </div>

            <div id="income-list-container" class="space-y-3">
                <!-- Items injected via JS -->
            </div>
            
            <div class="mt-8 text-center">
                <p class="text-xs text-slate-400 uppercase tracking-widest mb-1">Всего доходов</p>
                <p id="total-income-display" class="text-2xl font-bold text-slate-800">0 ₸</p>
            </div>
        </div>

        <!-- VIEW: EXPENSES -->
        <div id="view-expenses" class="fade-in hidden pb-20">
            <div class="bg-blue-50 border border-blue-100 rounded-xl p-3 mb-4 flex items-start gap-3">
                <i data-lucide="info" class="w-5 h-5 text-blue-500 mt-0.5 shrink-0"></i>
                <p class="text-xs text-blue-800 leading-relaxed">
                    Заполните <strong>План</strong> на месяц. 
                    Нажимайте <strong>+</strong>, чтобы добавить сумму новой покупки.
                </p>
            </div>

            <div id="expense-list-container" class="space-y-4">
                <!-- Items injected via JS -->
            </div>
        </div>

    </main>

    <!-- FLOATING ACTION BUTTON (Visible on Income/Expenses) -->
    <button id="fab-add" onclick="handleAddAction()" class="hidden fixed bottom-24 right-4 z-40 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg shadow-blue-300 transition-transform active:scale-90 flex items-center justify-center">
        <i data-lucide="plus" class="w-7 h-7"></i>
    </button>

    <!-- ADD EXPENSE MODAL -->
    <div id="add-expense-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4 modal-backdrop fade-in">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden transform transition-all scale-100">
            <div class="bg-slate-50 px-5 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">Добавить трату</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-6">
                <p class="text-sm text-slate-500 mb-2" id="modal-category-name">Категория</p>
                <div class="mb-5">
                    <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Сумма новой покупки</label>
                    <input 
                        type="number" id="modal-amount-input" inputmode="decimal"
                        class="w-full text-3xl font-bold text-slate-800 border-b-2 border-blue-500 focus:outline-none py-2 bg-transparent placeholder-slate-200"
                        placeholder="0" autofocus
                    >
                </div>
                <button onclick="confirmAddExpense()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-200 active:scale-[0.98] transition-all">
                    Добавить
                </button>
            </div>
        </div>
    </div>

    <!-- BOTTOM NAVIGATION BAR -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-slate-200 pb-safe-area-bottom z-40">
        <div class="flex justify-around items-center h-16 max-w-md mx-auto">
            <button onclick="switchTab('summary')" id="nav-summary" class="nav-item w-full h-full flex flex-col items-center justify-center gap-1 text-slate-400 transition-colors active active:scale-95">
                <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">Сводка</span>
            </button>
            <button onclick="switchTab('income')" id="nav-income" class="nav-item w-full h-full flex flex-col items-center justify-center gap-1 text-slate-400 transition-colors active:scale-95">
                <i data-lucide="banknote" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">Доходы</span>
            </button>
            <button onclick="switchTab('expenses')" id="nav-expenses" class="nav-item w-full h-full flex flex-col items-center justify-center gap-1 text-slate-400 transition-colors active:scale-95">
                <i data-lucide="pie-chart" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">Бюджет</span>
            </button>
        </div>
    </nav>

    <script>
        // --- DATA & STATE ---
        const DEFAULT_INCOME = [
            { id: 1, source: 'Зарплата', cash: 0, card: 0 },
            { id: 2, source: 'Подработка', cash: 0, card: 0 },
        ];

        const DEFAULT_EXPENSES = [
            { id: 1, category: 'Еда / Продукты', planCash: 0, planCard: 0, spent: 0 },
            { id: 2, category: 'Транспорт / Такси', planCash: 0, planCard: 0, spent: 0 },
            { id: 3, category: 'Жилье / Аренда', planCash: 0, planCard: 0, spent: 0 },
            { id: 4, category: 'Связь / Интернет', planCash: 0, planCard: 0, spent: 0 },
            { id: 5, category: 'Развлечения', planCash: 0, planCard: 0, spent: 0 },
            { id: 6, category: 'Одежда', planCash: 0, planCard: 0, spent: 0 },
            { id: 7, category: 'Здоровье / Аптека', planCash: 0, planCard: 0, spent: 0 },
            { id: 8, category: 'Накопления', planCash: 0, planCard: 0, spent: 0 },
            { id: 9, category: 'Прочее', planCash: 0, planCard: 0, spent: 0 },
        ];

        let incomeData = [];
        let expenseData = [];
        let activeTab = 'summary';
        let currentEditingExpenseId = null;
        
        // Date State
        let currentDate = new Date();

        // --- UTILS ---
        const formatMoney = (amount) => {
            return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'KZT', maximumFractionDigits: 0 }).format(amount);
        };

        const generateId = (arr) => arr.length > 0 ? Math.max(...arr.map(i => i.id)) + 1 : 1;

        // Get unique key for storage based on Year and Month (e.g., "2024-0")
        const getMonthKey = (date) => `${date.getFullYear()}-${date.getMonth()}`;

        // --- DATE MANAGEMENT ---
        function renderHeaderMonth() {
            const months = [
                "Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", 
                "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"
            ];
            const monthName = months[currentDate.getMonth()];
            const year = currentDate.getFullYear();
            document.getElementById('current-month-display').textContent = `${monthName} ${year}`;
        }

        function changeMonth(offset) {
            // Save current data before switching
            saveData();

            // Store current structure to use as template if next month is empty
            const templateIncome = JSON.parse(JSON.stringify(incomeData));
            const templateExpenses = JSON.parse(JSON.stringify(expenseData));

            // Change date
            currentDate.setMonth(currentDate.getMonth() + offset);
            renderHeaderMonth();

            // Load data for new month
            loadData(templateIncome, templateExpenses);
        }

        // --- STORAGE (Multi-month logic) ---
        function loadData(prevIncomeTemplate = null, prevExpensesTemplate = null) {
            const keySuffix = getMonthKey(currentDate);
            const incomeKey = `fin_income_${keySuffix}`;
            const expensesKey = `fin_expenses_${keySuffix}`;

            // Helper to handle loading logic
            const processData = (incomeVal, expensesVal) => {
                let isNewMonth = false;

                if (incomeVal) {
                    incomeData = JSON.parse(incomeVal);
                } else {
                    // New month: Copy structure from previous but zero out actuals
                    isNewMonth = true;
                    if (prevIncomeTemplate && prevIncomeTemplate.length > 0) {
                        incomeData = prevIncomeTemplate.map(item => ({ ...item, cash: 0, card: 0 }));
                    } else {
                        incomeData = JSON.parse(JSON.stringify(DEFAULT_INCOME));
                    }
                }

                if (expensesVal) {
                    expenseData = JSON.parse(expensesVal);
                } else {
                    // New month: Copy Plan but zero out Spent
                    if (prevExpensesTemplate && prevExpensesTemplate.length > 0) {
                        expenseData = prevExpensesTemplate.map(item => ({ ...item, spent: 0 }));
                    } else {
                        expenseData = JSON.parse(JSON.stringify(DEFAULT_EXPENSES));
                    }
                }

                renderSummaryView();
                renderIncomeList();
                renderExpenseList();
                updateGlobalUI();
            };

            // 1. Try LocalStorage first (Fast)
            const localIncome = localStorage.getItem(incomeKey);
            const localExpenses = localStorage.getItem(expensesKey);
            processData(localIncome, localExpenses);

            // 2. Try CloudStorage (Async sync)
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.CloudStorage) {
                const tg = window.Telegram.WebApp;
                // Check support
                if (tg.isVersionAtLeast && tg.isVersionAtLeast('6.9')) {
                     tg.CloudStorage.getItems([incomeKey, expensesKey], (err, values) => {
                        if (!err && values) {
                            // Only update if cloud has data
                            if (values[incomeKey] || values[expensesKey]) {
                                processData(values[incomeKey], values[expensesKey]);
                                // Sync back to local to keep them aligned
                                if (values[incomeKey]) localStorage.setItem(incomeKey, values[incomeKey]);
                                if (values[expensesKey]) localStorage.setItem(expensesKey, values[expensesKey]);
                            }
                        }
                    });
                }
            }
        }

        function saveData() {
            const keySuffix = getMonthKey(currentDate);
            const incomeKey = `fin_income_${keySuffix}`;
            const expensesKey = `fin_expenses_${keySuffix}`;

            const incomeStr = JSON.stringify(incomeData);
            const expenseStr = JSON.stringify(expenseData);

            // 1. Save Local
            localStorage.setItem(incomeKey, incomeStr);
            localStorage.setItem(expensesKey, expenseStr);

            // 2. Save Cloud
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.CloudStorage) {
                 const tg = window.Telegram.WebApp;
                 if (tg.isVersionAtLeast && tg.isVersionAtLeast('6.9')) {
                    tg.CloudStorage.setItem(incomeKey, incomeStr);
                    tg.CloudStorage.setItem(expensesKey, expenseStr);
                 }
            }
        }

        function resetData() {
            if(confirm('Очистить все данные за ТЕКУЩИЙ месяц? Это действие нельзя отменить.')) {
                const keySuffix = getMonthKey(currentDate);
                const incomeKey = `fin_income_${keySuffix}`;
                const expensesKey = `fin_expenses_${keySuffix}`;

                // Clear Local
                localStorage.removeItem(incomeKey);
                localStorage.removeItem(expensesKey);
                
                // Clear Cloud
                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.CloudStorage) {
                     const tg = window.Telegram.WebApp;
                     if (tg.isVersionAtLeast && tg.isVersionAtLeast('6.9')) {
                        tg.CloudStorage.removeItem(incomeKey);
                        tg.CloudStorage.removeItem(expensesKey);
                     }
                }

                // Reload (will trigger defaults)
                loadData(); 
                alert('Данные за этот месяц сброшены.');
            }
        }

        // --- CORE FUNCTIONS (Unchanged logic, just using current data) ---

        function calculateTotals() {
            const totalIncome = incomeData.reduce((acc, item) => acc + Number(item.cash) + Number(item.card), 0);
            const totalBudget = expenseData.reduce((acc, item) => acc + Number(item.planCash) + Number(item.planCard), 0);
            const totalSpent = expenseData.reduce((acc, item) => acc + Number(item.spent), 0);
            const balance = totalIncome - totalSpent;
            return { totalIncome, totalBudget, totalSpent, balance };
        }

        function updateGlobalUI() {
            const { totalIncome, totalBudget, totalSpent, balance } = calculateTotals();
            
            const headerBal = document.getElementById('header-balance');
            if(headerBal) {
                headerBal.textContent = formatMoney(balance);
                headerBal.className = `font-bold text-lg leading-none ${balance >= 0 ? 'text-emerald-600' : 'text-red-500'}`;
            }

            if (document.getElementById('total-income-display')) {
                document.getElementById('total-income-display').textContent = formatMoney(totalIncome);
            }

            if (activeTab === 'summary') {
                renderSummaryView();
            }
        }

        // --- RENDERERS ---

        function switchTab(tabName) {
            activeTab = tabName;
            ['summary', 'income', 'expenses'].forEach(t => {
                const view = document.getElementById(`view-${t}`);
                if (t === tabName) view.classList.remove('hidden');
                else view.classList.add('hidden');
            });

            ['summary', 'income', 'expenses'].forEach(t => {
                const navBtn = document.getElementById(`nav-${t}`);
                if (t === tabName) {
                    navBtn.classList.add('active', 'text-blue-600');
                    navBtn.classList.remove('text-slate-400');
                } else {
                    navBtn.classList.remove('active', 'text-blue-600');
                    navBtn.classList.add('text-slate-400');
                }
            });

            const fab = document.getElementById('fab-add');
            if (tabName === 'summary') fab.classList.add('hidden');
            else fab.classList.remove('hidden');

            if (tabName === 'summary') renderSummaryView();
            if (tabName === 'income') renderIncomeList();
            if (tabName === 'expenses') renderExpenseList();
            
            window.scrollTo(0,0);
            lucide.createIcons();
        }

        function handleAddAction() {
            if (activeTab === 'income') addIncomeItem();
            if (activeTab === 'expenses') addExpenseItem();
        }

        function renderSummaryView() {
            const { totalIncome, totalBudget, totalSpent, balance } = calculateTotals();
            
            document.getElementById('hero-balance').textContent = formatMoney(balance);
            document.getElementById('hero-income').textContent = formatMoney(totalIncome);
            document.getElementById('hero-spent').textContent = formatMoney(totalSpent);

            document.getElementById('summary-budget').textContent = formatMoney(totalBudget);
            document.getElementById('summary-remaining').textContent = formatMoney(totalBudget - totalSpent);

            const percentage = totalBudget > 0 ? Math.round((totalSpent / totalBudget) * 100) : 0;
            const isOver = totalSpent > totalBudget;
            
            document.getElementById('budget-percent').textContent = `${percentage}%`;
            
            const bar = document.getElementById('budget-progress-bar');
            bar.style.width = `${Math.min(percentage, 100)}%`;
            bar.className = `shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center transition-all duration-500 rounded-full h-full ${isOver ? 'bg-red-500' : 'bg-blue-500'}`;

            const textEl = document.getElementById('budget-text');
            if (isOver) {
                textEl.innerHTML = `<span class="text-red-500 font-medium">Перерасход на ${formatMoney(totalSpent - totalBudget)}</span>`;
            } else {
                textEl.innerHTML = `<span>Свободно в бюджете: <span class="font-medium text-emerald-600">${formatMoney(totalBudget - totalSpent)}</span></span>`;
            }
        }

        function renderIncomeList() {
            const container = document.getElementById('income-list-container');
            container.innerHTML = ''; 

            incomeData.forEach((item) => {
                const total = Number(item.cash) + Number(item.card);
                
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative transition-all active:scale-[0.99]";
                card.innerHTML = `
                  <div class="flex justify-between items-start mb-3">
                     <input 
                      type="text" 
                      value="${item.source}" 
                      oninput="updateIncomeData(${item.id}, 'source', this.value)"
                      class="text-lg font-bold text-slate-800 bg-transparent w-full focus:outline-none focus:border-b focus:border-blue-500 placeholder-slate-300"
                      placeholder="Источник..."
                    />
                    <button onclick="deleteIncome(${item.id})" class="text-slate-300 hover:text-red-500 p-2 -mr-2 -mt-2">
                      <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                  </div>
                  
                  <div class="flex gap-3">
                    <div class="flex-1">
                      <label class="text-[10px] uppercase tracking-wider text-slate-400 font-bold mb-1 block">Наличные</label>
                      <input 
                        type="number" inputmode="decimal"
                        value="${item.cash === 0 ? '' : item.cash}"
                        oninput="updateIncomeData(${item.id}, 'cash', this.value)"
                        class="bg-slate-50 border border-slate-200 rounded-xl px-3 py-3 w-full text-slate-800 font-medium text-base focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all"
                        placeholder="0"
                      />
                    </div>
                    <div class="flex-1">
                       <label class="text-[10px] uppercase tracking-wider text-slate-400 font-bold mb-1 block">Карта</label>
                       <input 
                          type="number" inputmode="decimal"
                          value="${item.card === 0 ? '' : item.card}"
                          oninput="updateIncomeData(${item.id}, 'card', this.value)"
                          class="bg-slate-50 border border-slate-200 rounded-xl px-3 py-3 w-full text-slate-800 font-medium text-base focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all"
                          placeholder="0"
                        />
                    </div>
                  </div>
                  <div class="mt-3 flex justify-between items-center bg-slate-50 -mx-4 -mb-4 px-4 py-2 rounded-b-2xl border-t border-slate-100">
                    <span class="text-xs text-slate-400 font-medium">Сумма</span>
                    <span id="income-row-total-${item.id}" class="text-emerald-600 font-bold text-lg">${formatMoney(total)}</span>
                  </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        function renderExpenseList() {
            const container = document.getElementById('expense-list-container');
            container.innerHTML = '';

            expenseData.forEach((item) => {
                const budget = Number(item.planCash) + Number(item.planCard);
                const spent = Number(item.spent);
                const remaining = budget - spent;
                const isOverBudget = remaining < 0;
                const percent = budget > 0 ? (spent / budget) * 100 : 0;

                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative transition-all";
                
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                      <input 
                        type="text" 
                        value="${item.category}"
                        oninput="updateExpenseData(${item.id}, 'category', this.value)"
                        class="text-lg font-bold text-slate-800 bg-transparent w-full focus:outline-none focus:border-b focus:border-blue-500 placeholder-slate-300 mr-2"
                        placeholder="Категория..."
                      />
                      <button onclick="deleteExpense(${item.id})" class="text-slate-300 hover:text-red-500 p-2 -mr-2 -mt-2">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                      </button>
                    </div>

                    <div class="grid grid-cols-5 gap-3 mb-3">
                      <!-- Plan Inputs (Smaller) -->
                      <div class="col-span-2 bg-slate-50 p-2 rounded-xl border border-slate-100">
                        <label class="text-[9px] uppercase tracking-wider text-slate-400 font-bold mb-1 block">План (Нал/Карта)</label>
                        <input 
                            type="number" inputmode="decimal"
                            value="${item.planCash === 0 ? '' : item.planCash}"
                            oninput="updateExpenseData(${item.id}, 'planCash', this.value)"
                            class="bg-white border border-slate-200 rounded-lg px-2 py-1.5 w-full text-sm mb-1.5 focus:outline-none focus:border-blue-400"
                            placeholder="Нал"
                        />
                        <input 
                            type="number" inputmode="decimal"
                            value="${item.planCard === 0 ? '' : item.planCard}"
                            oninput="updateExpenseData(${item.id}, 'planCard', this.value)"
                            class="bg-white border border-slate-200 rounded-lg px-2 py-1.5 w-full text-sm focus:outline-none focus:border-blue-400"
                            placeholder="Карта"
                        />
                      </div>

                      <!-- Spent Input with Add Button (Larger) -->
                      <div class="col-span-3 bg-slate-50 p-2 rounded-xl border border-slate-100 flex flex-col relative overflow-hidden">
                         <div id="progress-bg-${item.id}" class="absolute bottom-0 left-0 h-1 transition-all duration-300 ${isOverBudget ? 'bg-red-500' : 'bg-blue-500'}" style="width: ${Math.min(percent, 100)}%"></div>
                         <label class="text-[9px] uppercase tracking-wider text-slate-400 font-bold mb-1 block text-center">Факт. Трата</label>
                         
                         <div class="flex items-center gap-2 h-full">
                             <input 
                              type="number" inputmode="decimal"
                              id="input-spent-${item.id}"
                              value="${item.spent === 0 ? '' : item.spent}"
                              oninput="updateExpenseData(${item.id}, 'spent', this.value)"
                              class="bg-white border border-slate-200 rounded-lg px-2 py-2 w-full text-xl font-bold text-center focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all text-slate-800"
                              placeholder="0"
                            />
                            <button onclick="openAddExpenseModal(${item.id})" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg shadow-md active:scale-95 transition-all">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                            </button>
                         </div>
                      </div>
                    </div>

                    <!-- Footer Info -->
                    <div class="flex justify-between items-center text-xs">
                        <div class="text-slate-400">
                            План: <span id="exp-total-${item.id}" class="font-semibold text-slate-600">${formatMoney(budget)}</span>
                        </div>
                        <div id="remaining-text-${item.id}" class="font-bold bg-slate-100 px-2 py-1 rounded-md ${isOverBudget ? 'text-red-500 bg-red-50' : 'text-emerald-600 bg-emerald-50'}">
                            ${remaining < 0 ? 'Перерасход ' : 'Остаток: '}${formatMoney(Math.abs(remaining))}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- ADD EXPENSE MODAL LOGIC ---

        function openAddExpenseModal(id) {
            currentEditingExpenseId = id;
            const item = expenseData.find(e => e.id === id);
            document.getElementById('modal-category-name').textContent = `Добавить к: ${item.category}`;
            document.getElementById('modal-amount-input').value = '';
            
            const modal = document.getElementById('add-expense-modal');
            modal.classList.remove('hidden');
            
            setTimeout(() => {
                document.getElementById('modal-amount-input').focus();
            }, 100);
        }

        function closeModal() {
            const modal = document.getElementById('add-expense-modal');
            modal.classList.add('hidden');
            currentEditingExpenseId = null;
        }

        function confirmAddExpense() {
            if (!currentEditingExpenseId) return;

            const input = document.getElementById('modal-amount-input');
            const addAmount = Number(input.value);

            if (addAmount > 0) {
                const idx = expenseData.findIndex(e => e.id === currentEditingExpenseId);
                if (idx !== -1) {
                    const currentSpent = Number(expenseData[idx].spent);
                    const newTotal = currentSpent + addAmount;
                    updateExpenseData(currentEditingExpenseId, 'spent', newTotal);
                    const uiInput = document.getElementById(`input-spent-${currentEditingExpenseId}`);
                    if(uiInput) uiInput.value = newTotal;
                }
            }
            closeModal();
        }

        // --- EVENTS & UPDATES ---

        function updateIncomeData(id, field, value) {
            const idx = incomeData.findIndex(i => i.id === id);
            if (idx !== -1) {
                incomeData[idx][field] = field === 'source' ? value : Number(value);
                saveData(); 
                
                const item = incomeData[idx];
                const total = Number(item.cash) + Number(item.card);
                const rowTotalEl = document.getElementById(`income-row-total-${id}`);
                if (rowTotalEl) rowTotalEl.textContent = formatMoney(total);
                updateGlobalUI();
            }
        }

        function updateExpenseData(id, field, value) {
            const idx = expenseData.findIndex(e => e.id === id);
            if (idx !== -1) {
                expenseData[idx][field] = field === 'category' ? value : Number(value);
                saveData();

                const item = expenseData[idx];
                const budget = Number(item.planCash) + Number(item.planCard);
                const spent = Number(item.spent);
                const remaining = budget - spent;
                const isOverBudget = remaining < 0;
                const percent = budget > 0 ? (spent / budget) * 100 : 0;

                const budgetEl = document.getElementById(`exp-total-${id}`);
                if (budgetEl) budgetEl.textContent = formatMoney(budget);

                const remEl = document.getElementById(`remaining-text-${id}`);
                if (remEl) {
                    remEl.textContent = `${remaining < 0 ? 'Перерасход ' : 'Остаток: '}${formatMoney(Math.abs(remaining))}`;
                    remEl.className = `font-bold px-2 py-1 rounded-md ${isOverBudget ? 'text-red-500 bg-red-50' : 'text-emerald-600 bg-emerald-50'}`;
                }

                const progressBg = document.getElementById(`progress-bg-${item.id}`);
                if (progressBg) {
                    progressBg.style.width = `${Math.min(percent, 100)}%`;
                    progressBg.className = `absolute bottom-0 left-0 h-1 transition-all duration-300 ${isOverBudget ? 'bg-red-500' : 'bg-blue-500'}`;
                }

                updateGlobalUI();
            }
        }

        function addIncomeItem() {
            const newId = generateId(incomeData);
            incomeData.push({ id: newId, source: '', cash: 0, card: 0 });
            saveData();
            renderIncomeList();
            updateGlobalUI();
        }

        function deleteIncome(id) {
            incomeData = incomeData.filter(i => i.id !== id);
            saveData();
            renderIncomeList();
            updateGlobalUI();
        }

        function addExpenseItem() {
            const newId = generateId(expenseData);
            expenseData.unshift({ id: newId, category: '', planCash: 0, planCard: 0, spent: 0 });
            saveData();
            renderExpenseList();
            updateGlobalUI();
        }

        function deleteExpense(id) {
            expenseData = expenseData.filter(e => e.id !== id);
            saveData();
            renderExpenseList();
            updateGlobalUI();
        }

        // --- INIT ---
        window.onload = function() {
            renderHeaderMonth();
            loadData(); // Load current month data
            initTelegram(); // Init telegram features
            
            // Expand telegram view if possible
            if (window.Telegram && window.Telegram.WebApp) {
                try { window.Telegram.WebApp.expand(); } catch(e){}
            }
            
            switchTab('summary');
        };

        function initTelegram() {
             if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
             }
        }

    </script>
</body>
</html>
