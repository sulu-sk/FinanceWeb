<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мои Финансы</title>
    <!-- Подключаем Tailwind CSS для стилей -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключаем иконки Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Дополнительные стили для плавности */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Убираем стрелочки у input type number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans pb-24 md:pb-10 min-h-screen">

    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-3 md:py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <i data-lucide="wallet" class="w-5 h-5 text-white"></i>
                </div>
                <h1 class="text-lg md:text-xl font-bold text-slate-800">Мои Финансы</h1>
            </div>
            <div class="text-right hidden sm:block">
                <p class="text-xs text-slate-500">Баланс</p>
                <p id="header-balance" class="font-bold text-emerald-600">0 ₸</p>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-4 md:py-6 space-y-6">
        
        <!-- NAVIGATION TABS -->
        <div class="flex bg-white md:bg-slate-200 p-1 rounded-xl shadow-sm md:shadow-none border border-slate-100 md:border-none sticky top-[60px] z-20 md:static">
            <button onclick="switchTab('summary')" id="tab-summary" class="flex-1 py-2.5 px-2 rounded-lg text-xs md:text-sm font-medium transition-all text-center bg-blue-50 md:bg-white text-blue-600 shadow-sm">
                Сводка
            </button>
            <button onclick="switchTab('income')" id="tab-income" class="flex-1 py-2.5 px-2 rounded-lg text-xs md:text-sm font-medium transition-all text-center text-slate-500 hover:text-slate-700">
                Доходы
            </button>
            <button onclick="switchTab('expenses')" id="tab-expenses" class="flex-1 py-2.5 px-2 rounded-lg text-xs md:text-sm font-medium transition-all text-center text-slate-500 hover:text-slate-700">
                Бюджет
            </button>
        </div>

        <!-- VIEW: SUMMARY -->
        <div id="view-summary" class="fade-in block">
            <div class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 md:gap-4">
                    <!-- Cards will be injected via JS -->
                    <div id="summary-cards-container" class="contents"></div>
                </div>

                <!-- Budget Status -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-lg mb-4">Статус бюджета</h3>
                    <div class="relative pt-1">
                        <div class="flex mb-2 items-center justify-between">
                            <div>
                                <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-100">
                                    Исполнение
                                </span>
                            </div>
                            <div class="text-right">
                                <span id="budget-percent" class="text-xs font-semibold inline-block text-blue-600">0%</span>
                            </div>
                        </div>
                        <div class="overflow-hidden h-3 mb-2 text-xs flex rounded-full bg-slate-100">
                            <div id="budget-progress-bar" style="width: 0%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500 transition-all duration-500"></div>
                        </div>
                        <p id="budget-text" class="text-sm text-slate-500">Загрузка...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: INCOME -->
        <div id="view-income" class="fade-in hidden">
            <div class="flex justify-between items-center mb-4 px-1">
                <h3 class="font-bold text-lg text-slate-700">Источники</h3>
                <button onclick="addIncomeItem()" class="bg-emerald-500 hover:bg-emerald-600 active:scale-95 text-white py-2 px-4 rounded-xl text-sm font-medium transition-all shadow-sm flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span>Добавить</span>
                </button>
            </div>
            
            <div id="income-list-container" class="space-y-3">
                <!-- Income items injected here -->
            </div>
            
            <!-- Total Income Footer for List -->
            <div class="hidden md:block mt-4 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                 <div class="p-4 bg-emerald-50 flex justify-between items-center">
                     <span class="font-bold text-emerald-800">ВСЕГО ДОХОД</span>
                     <span id="total-income-display" class="font-bold text-xl text-emerald-700">0 ₸</span>
                 </div>
            </div>
        </div>

        <!-- VIEW: EXPENSES -->
        <div id="view-expenses" class="fade-in hidden">
            <div class="flex justify-between items-center mb-2 px-1">
                <h3 class="font-bold text-lg text-slate-700">План и Траты</h3>
                <button onclick="addExpenseItem()" class="bg-blue-500 hover:bg-blue-600 active:scale-95 text-white py-2 px-4 rounded-xl text-sm font-medium transition-all shadow-sm flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span>Категория</span>
                </button>
            </div>

            <div id="expense-list-container" class="space-y-4">
                <!-- Expense items injected here -->
            </div>

            <!-- Total Expenses Block -->
            <div class="bg-slate-800 text-white p-5 rounded-2xl shadow-lg mt-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-slate-300 text-sm">Общий бюджет</span>
                    <span id="footer-total-budget" class="font-bold">0 ₸</span>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <span class="text-slate-300 text-sm">Потрачено всего</span>
                    <span id="footer-total-spent" class="font-bold text-red-300">0 ₸</span>
                </div>
                <div class="border-t border-slate-700 pt-3 flex justify-between items-center">
                    <span class="font-bold text-lg">Остаток</span>
                    <span id="footer-total-balance" class="font-bold text-xl">0 ₸</span>
                </div>
            </div>
        </div>

    </main>

    <!-- MOBILE FOOTER (Sticky) -->
    <div class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 p-4 md:hidden safe-area-bottom z-30">
        <div class="flex justify-between items-center max-w-lg mx-auto">
           <div class="flex flex-col">
             <span class="text-[10px] text-slate-500 uppercase tracking-wide font-bold">Текущий остаток</span>
             <span id="mobile-footer-balance" class="font-bold text-xl leading-none text-emerald-600">0 ₸</span>
           </div>
           <div class="bg-slate-100 rounded-full px-3 py-1 flex items-center gap-2">
              <span id="mobile-footer-budget" class="text-xs text-slate-500">План: 0 ₸</span>
           </div>
        </div>
     </div>

    <script>
        // --- DATA ---
        let incomeData = [
            { id: 1, source: 'Зарплата', cash: 0, card: 60000 },
            { id: 2, source: 'Подработка', cash: 0, card: 0 },
            { id: 3, source: 'Прочее', cash: 24000, card: 0 },
        ];

        let expenseData = [
            { id: 1, category: 'Подарки', planCash: 10000, planCard: 5000, spent: 15000 },
            { id: 2, category: 'Еда', planCash: 0, planCard: 2000, spent: 90 },
            { id: 3, category: 'Транспорт', planCash: 0, planCard: 5000, spent: 500 },
            { id: 4, category: 'Связь и интернет', planCash: 0, planCard: 2900, spent: 0 },
            { id: 5, category: 'Развлечения', planCash: 10000, planCard: 0, spent: 0 },
            { id: 6, category: 'Одежда', planCash: 0, planCard: 0, spent: 0 },
            { id: 7, category: 'Здоровье', planCash: 0, planCard: 35000, spent: 35000 },
            { id: 8, category: 'Образование', planCash: 0, planCard: 0, spent: 0 },
            { id: 9, category: 'Депозит', planCash: 0, planCard: 10000, spent: 10000 },
            { id: 10, category: 'Прочее', planCash: 0, planCard: 4100, spent: 1600 },
        ];

        let activeTab = 'summary';

        // --- UTILS ---
        const formatMoney = (amount) => {
            return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'KZT', maximumFractionDigits: 0 }).format(amount);
        };

        const generateId = (arr) => arr.length > 0 ? Math.max(...arr.map(i => i.id)) + 1 : 1;

        // --- CORE FUNCTIONS ---

        function calculateTotals() {
            const totalIncome = incomeData.reduce((acc, item) => acc + Number(item.cash) + Number(item.card), 0);
            const totalBudget = expenseData.reduce((acc, item) => acc + Number(item.planCash) + Number(item.planCard), 0);
            const totalSpent = expenseData.reduce((acc, item) => acc + Number(item.spent), 0);
            const balance = totalIncome - totalSpent;
            return { totalIncome, totalBudget, totalSpent, balance };
        }

        function updateGlobalUI() {
            const { totalIncome, totalBudget, totalSpent, balance } = calculateTotals();
            
            // Header Balance
            const headerBal = document.getElementById('header-balance');
            headerBal.textContent = formatMoney(balance);
            headerBal.className = `font-bold ${balance >= 0 ? 'text-emerald-600' : 'text-red-500'}`;

            // Mobile Footer Balance
            const mobFooterBal = document.getElementById('mobile-footer-balance');
            mobFooterBal.textContent = formatMoney(balance);
            mobFooterBal.className = `font-bold text-xl leading-none ${balance >= 0 ? 'text-emerald-600' : 'text-red-500'}`;

            document.getElementById('mobile-footer-budget').textContent = `План: ${formatMoney(totalBudget)}`;

            // Footer in Expenses Tab
            document.getElementById('footer-total-budget').textContent = formatMoney(totalBudget);
            document.getElementById('footer-total-spent').textContent = formatMoney(totalSpent);
            const footerBal = document.getElementById('footer-total-balance');
            footerBal.textContent = formatMoney(balance);
            footerBal.className = `font-bold text-xl ${balance >= 0 ? 'text-emerald-400' : 'text-red-400'}`;

            // Income Tab Total
            if (document.getElementById('total-income-display')) {
                document.getElementById('total-income-display').textContent = formatMoney(totalIncome);
            }

            // Summary View Updates (if active)
            if (activeTab === 'summary') {
                renderSummaryView();
            }
        }

        // --- RENDERERS ---

        function switchTab(tabName) {
            activeTab = tabName;
            
            // UI State for Tabs
            ['summary', 'income', 'expenses'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const view = document.getElementById(`view-${t}`);
                
                if (t === tabName) {
                    btn.className = "flex-1 py-2.5 px-2 rounded-lg text-xs md:text-sm font-medium transition-all text-center bg-blue-50 md:bg-white text-blue-600 shadow-sm";
                    btn.classList.remove('text-slate-500');
                    view.classList.remove('hidden');
                } else {
                    btn.className = "flex-1 py-2.5 px-2 rounded-lg text-xs md:text-sm font-medium transition-all text-center text-slate-500 hover:text-slate-700";
                    view.classList.add('hidden');
                }
            });

            if (tabName === 'summary') renderSummaryView();
            // Lists are rendered once or on data change, not necessarily on tab switch, 
            // but for simplicity we can refresh them to ensure sync
            if (tabName === 'income') renderIncomeList();
            if (tabName === 'expenses') renderExpenseList();
            
            lucide.createIcons();
        }

        function renderSummaryView() {
            const { totalIncome, totalBudget, totalSpent, balance } = calculateTotals();
            const container = document.getElementById('summary-cards-container');
            
            const cards = [
                { title: 'Общий доход', amount: totalIncome, icon: 'trending-up', color: 'text-emerald-600', sub: '' },
                { title: 'Всего потрачено', amount: totalSpent, icon: 'credit-card', color: 'text-indigo-600', sub: `Из бюджета: ${formatMoney(totalBudget)}` },
                { title: 'План (Бюджет)', amount: totalBudget, icon: 'pie-chart', color: 'text-blue-600', sub: '' },
                { title: 'Остаток', amount: balance, icon: 'wallet', color: balance >= 0 ? 'text-emerald-600' : 'text-red-500', sub: '' }
            ];

            container.innerHTML = cards.map(card => `
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between">
                    <div>
                        <p class="text-slate-500 text-sm font-medium mb-1">${card.title}</p>
                        <h3 class="text-2xl font-bold ${card.color}">${formatMoney(card.amount)}</h3>
                        ${card.sub ? `<p class="text-xs text-slate-400 mt-1">${card.sub}</p>` : ''}
                    </div>
                    <div class="p-3 rounded-full ${card.color.replace('text-', 'bg-').replace('600', '100')}">
                        <i data-lucide="${card.icon}" class="w-6 h-6 ${card.color}"></i>
                    </div>
                </div>
            `).join('');

            // Budget Status logic
            const percentage = totalBudget > 0 ? Math.round((totalSpent / totalBudget) * 100) : 0;
            const isOver = totalSpent > totalBudget;
            
            document.getElementById('budget-percent').textContent = `${percentage}%`;
            
            const bar = document.getElementById('budget-progress-bar');
            bar.style.width = `${Math.min(percentage, 100)}%`;
            bar.className = `shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center transition-all duration-500 h-full ${isOver ? 'bg-red-500' : 'bg-blue-500'}`;

            const textEl = document.getElementById('budget-text');
            if (isOver) {
                textEl.innerHTML = `<span class="text-red-500 font-medium">Перерасход: ${formatMoney(totalSpent - totalBudget)}</span>`;
            } else {
                textEl.innerHTML = `<span>Доступно: <span class="font-medium text-emerald-600">${formatMoney(totalBudget - totalSpent)}</span></span>`;
            }
            
            lucide.createIcons();
        }

        function renderIncomeList() {
            const container = document.getElementById('income-list-container');
            container.innerHTML = ''; // Clear

            // Mobile Cards + Desktop Table hybrid logic is tricky in pure string HTML, 
            // so we'll use the "Mobile Cards" layout which looks good on both,
            // or we could implement a CSS grid. Let's stick to the mobile-friendly card layout 
            // from the React version as it's cleaner to generate.

            // Note: In pure JS, re-rendering the whole list on input blur/input is easiest. 
            // To prevent focus loss, we can use "onchange" instead of "oninput" for values, 
            // or simply re-render only when items are added/deleted.

            incomeData.forEach((item, index) => {
                const total = Number(item.cash) + Number(item.card);
                
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl border border-slate-100 shadow-sm relative";
                card.innerHTML = `
                  <div class="flex justify-between items-start mb-3">
                     <input 
                      type="text" 
                      value="${item.source}" 
                      oninput="updateIncomeData(${item.id}, 'source', this.value)"
                      class="text-lg font-semibold text-slate-800 bg-transparent w-full focus:outline-none focus:border-b focus:border-emerald-500 placeholder-slate-300"
                      placeholder="Название источника"
                    />
                    <button onclick="deleteIncome(${item.id})" class="text-slate-300 hover:text-red-500 p-1 -mt-1 -mr-1">
                      <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label class="text-[10px] uppercase tracking-wider text-slate-400 font-bold mb-1 block">Наличные</label>
                      <div class="relative">
                        <input 
                          type="number" 
                          value="${item.cash === 0 ? '' : item.cash}"
                          oninput="updateIncomeData(${item.id}, 'cash', this.value)"
                          class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 w-full text-slate-800 font-medium focus:outline-none focus:ring-2 focus:ring-emerald-100 focus:border-emerald-500 transition-all"
                          placeholder="0"
                        />
                      </div>
                    </div>
                    <div>
                       <label class="text-[10px] uppercase tracking-wider text-slate-400 font-bold mb-1 block">Карта</label>
                       <div class="relative">
                        <input 
                          type="number" 
                          value="${item.card === 0 ? '' : item.card}"
                          oninput="updateIncomeData(${item.id}, 'card', this.value)"
                          class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 w-full text-slate-800 font-medium focus:outline-none focus:ring-2 focus:ring-emerald-100 focus:border-emerald-500 transition-all"
                          placeholder="0"
                        />
                       </div>
                    </div>
                  </div>
                  <div class="mt-3 pt-3 border-t border-slate-50 flex justify-between items-center">
                    <span class="text-xs text-slate-400">Итого</span>
                    <span id="income-row-total-${item.id}" class="text-emerald-600 font-bold text-lg">${formatMoney(total)}</span>
                  </div>
                `;
                container.appendChild(card);
            });
            
            // Render Desktop-like total block at bottom
            const totalBlock = document.createElement('div');
            totalBlock.className = "bg-emerald-50 p-4 rounded-xl border border-emerald-100 flex justify-between items-center md:hidden";
            totalBlock.innerHTML = `
                 <span class="font-bold text-emerald-800">ВСЕГО ДОХОД</span>
                 <span id="mobile-income-total" class="font-bold text-xl text-emerald-700">${formatMoney(calculateTotals().totalIncome)}</span>
            `;
            container.appendChild(totalBlock);

            lucide.createIcons();
        }

        function renderExpenseList() {
            const container = document.getElementById('expense-list-container');
            container.innerHTML = '';

            expenseData.forEach((item) => {
                const budget = Number(item.planCash) + Number(item.planCard);
                const spent = Number(item.spent);
                const remaining = budget - spent;
                const isOverBudget = remaining < 0;
                const percent = budget > 0 ? (spent / budget) * 100 : 0;

                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl border border-slate-100 shadow-sm relative";
                
                // Construct HTML with unique IDs for dynamic updates
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                      <input 
                        type="text" 
                        value="${item.category}"
                        oninput="updateExpenseData(${item.id}, 'category', this.value)"
                        class="text-lg font-bold text-slate-800 bg-transparent w-full focus:outline-none focus:border-b focus:border-blue-500 placeholder-slate-300"
                        placeholder="Название категории"
                      />
                      <button onclick="deleteExpense(${item.id})" class="text-slate-300 hover:text-red-500 p-2 -mr-2 -mt-2">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                      </button>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                      <!-- Plan Section -->
                      <div class="bg-blue-50/50 p-3 rounded-lg border border-blue-50">
                        <label class="text-[10px] uppercase tracking-wider text-blue-500 font-bold mb-2 block flex items-center gap-1">
                          <i data-lucide="pie-chart" class="w-3 h-3"></i> План
                        </label>
                        <div class="space-y-2">
                          <div>
                            <span class="text-[10px] text-slate-400 block mb-0.5">Наличные</span>
                            <input 
                              type="number" 
                              value="${item.planCash === 0 ? '' : item.planCash}"
                              oninput="updateExpenseData(${item.id}, 'planCash', this.value)"
                              class="bg-white border border-blue-100 rounded px-2 py-1.5 w-full text-sm focus:outline-none focus:ring-1 focus:ring-blue-400"
                              placeholder="0"
                            />
                          </div>
                          <div>
                            <span class="text-[10px] text-slate-400 block mb-0.5">Карта</span>
                            <input 
                              type="number" 
                              value="${item.planCard === 0 ? '' : item.planCard}"
                              oninput="updateExpenseData(${item.id}, 'planCard', this.value)"
                              class="bg-white border border-blue-100 rounded px-2 py-1.5 w-full text-sm focus:outline-none focus:ring-1 focus:ring-blue-400"
                              placeholder="0"
                            />
                          </div>
                        </div>
                         <div class="mt-2 text-right">
                           <span class="text-xs text-blue-400">Всего: </span>
                           <span id="exp-total-${item.id}" class="text-sm font-bold text-blue-700">${formatMoney(budget)}</span>
                         </div>
                      </div>

                      <!-- Spent Section -->
                      <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 flex flex-col justify-between">
                         <label class="text-[10px] uppercase tracking-wider text-slate-500 font-bold mb-2 block flex items-center gap-1">
                          <i data-lucide="credit-card" class="w-3 h-3"></i> Потрачено
                        </label>
                        <input 
                          type="number" 
                          id="input-spent-${item.id}"
                          value="${item.spent === 0 ? '' : item.spent}"
                          oninput="updateExpenseData(${item.id}, 'spent', this.value)"
                          class="bg-white border-2 rounded-lg px-2 py-3 w-full text-lg font-bold text-center focus:outline-none focus:ring-2 focus:ring-offset-1 transition-all ${isOverBudget ? 'border-red-200 text-red-600 focus:ring-red-200' : 'border-slate-200 text-slate-700 focus:ring-blue-200'}"
                          placeholder="0"
                        />
                         <div id="status-text-${item.id}" class="mt-2 text-center text-xs font-medium ${isOverBudget ? 'text-red-500' : 'text-emerald-600'}">
                           ${isOverBudget ? 'Перерасход' : 'В рамках'}
                         </div>
                      </div>
                    </div>

                    <!-- Progress Bar Footer -->
                    <div class="pt-2">
                      <div class="flex justify-between text-xs mb-1">
                        <span class="text-slate-400">Исполнение бюджета</span>
                        <span id="remaining-text-${item.id}" class="font-bold ${isOverBudget ? 'text-red-500' : 'text-slate-600'}">
                          ${remaining < 0 ? '-' : ''}${formatMoney(Math.abs(remaining))} ${remaining >= 0 ? 'ост.' : 'over'}
                        </span>
                      </div>
                      <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                        <div 
                          id="progress-bar-${item.id}"
                          class="h-full rounded-full transition-all duration-500 ${isOverBudget ? 'bg-red-500' : 'bg-blue-500'}"
                          style="width: ${Math.min(percent, 100)}%"
                        ></div>
                      </div>
                    </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- EVENTS & UPDATES ---

        function updateIncomeData(id, field, value) {
            const idx = incomeData.findIndex(i => i.id === id);
            if (idx !== -1) {
                incomeData[idx][field] = field === 'source' ? value : Number(value);
                
                // Update local calculation
                const item = incomeData[idx];
                const total = Number(item.cash) + Number(item.card);
                const rowTotalEl = document.getElementById(`income-row-total-${id}`);
                if (rowTotalEl) rowTotalEl.textContent = formatMoney(total);

                // Update Mobile income total block
                const mobTotal = document.getElementById('mobile-income-total');
                if (mobTotal) mobTotal.textContent = formatMoney(calculateTotals().totalIncome);

                updateGlobalUI();
            }
        }

        function updateExpenseData(id, field, value) {
            const idx = expenseData.findIndex(e => e.id === id);
            if (idx !== -1) {
                expenseData[idx][field] = field === 'category' ? value : Number(value);
                
                const item = expenseData[idx];
                const budget = Number(item.planCash) + Number(item.planCard);
                const spent = Number(item.spent);
                const remaining = budget - spent;
                const isOverBudget = remaining < 0;
                const percent = budget > 0 ? (spent / budget) * 100 : 0;

                // Live DOM updates for this card to avoid re-rendering input
                
                // 1. Budget Total in card
                const budgetEl = document.getElementById(`exp-total-${id}`);
                if (budgetEl) budgetEl.textContent = formatMoney(budget);

                // 2. Spent Input Styles
                const spentInput = document.getElementById(`input-spent-${id}`);
                if (spentInput) {
                    if (isOverBudget) {
                        spentInput.className = "bg-white border-2 rounded-lg px-2 py-3 w-full text-lg font-bold text-center focus:outline-none focus:ring-2 focus:ring-offset-1 transition-all border-red-200 text-red-600 focus:ring-red-200";
                    } else {
                        spentInput.className = "bg-white border-2 rounded-lg px-2 py-3 w-full text-lg font-bold text-center focus:outline-none focus:ring-2 focus:ring-offset-1 transition-all border-slate-200 text-slate-700 focus:ring-blue-200";
                    }
                }

                // 3. Status Text
                const statusEl = document.getElementById(`status-text-${id}`);
                if (statusEl) {
                    statusEl.textContent = isOverBudget ? 'Перерасход' : 'В рамках';
                    statusEl.className = `mt-2 text-center text-xs font-medium ${isOverBudget ? 'text-red-500' : 'text-emerald-600'}`;
                }

                // 4. Remaining Text
                const remEl = document.getElementById(`remaining-text-${id}`);
                if (remEl) {
                    remEl.innerHTML = `${remaining < 0 ? '-' : ''}${formatMoney(Math.abs(remaining))} ${remaining >= 0 ? 'ост.' : 'over'}`;
                    remEl.className = `font-bold ${isOverBudget ? 'text-red-500' : 'text-slate-600'}`;
                }

                // 5. Progress Bar
                const bar = document.getElementById(`progress-bar-${id}`);
                if (bar) {
                    bar.style.width = `${Math.min(percent, 100)}%`;
                    bar.className = `h-full rounded-full transition-all duration-500 ${isOverBudget ? 'bg-red-500' : 'bg-blue-500'}`;
                }

                updateGlobalUI();
            }
        }

        function addIncomeItem() {
            const newId = generateId(incomeData);
            incomeData.push({ id: newId, source: '', cash: 0, card: 0 });
            renderIncomeList();
            updateGlobalUI();
        }

        function deleteIncome(id) {
            incomeData = incomeData.filter(i => i.id !== id);
            renderIncomeList();
            updateGlobalUI();
        }

        function addExpenseItem() {
            const newId = generateId(expenseData);
            expenseData.push({ id: newId, category: '', planCash: 0, planCard: 0, spent: 0 });
            renderExpenseList();
            updateGlobalUI();
        }

        function deleteExpense(id) {
            expenseData = expenseData.filter(e => e.id !== id);
            renderExpenseList();
            updateGlobalUI();
        }

        // --- INIT ---
        window.onload = function() {
            updateGlobalUI();
            switchTab('summary');
        };

    </script>
</body>
</html>